# tone

## 目的・コンセプト

時間軸なしの音高可視化。

極座標：角度=五度圏（12等分、上= C）、半径=周波数の対数（1オクターブ=同心1目盛り、外側ほど低音）。

調性感は五度圏の半円で表現。転調は**指数移動平均(EMA)**で滑らかに追従。

## 入力と再生

3モード：Mic（多重F0推定）、MIDI In、MIDI File。

MIDI File：読み込み、再生/一時停止/停止、シーク、速度10–200%。

音声出力：MIDI In/ファイルは内蔵シンセで同時再生。Micはモニターゲインで制御。

許容レイテンシ：100 ms以下でOK。

## 検出・アルゴリズム

Mic：HPS系の複数F0検出（最大数=ユーザ設定1–16）。

MIDI：同時発音ノートのベロシティを重み化。

調推定：五度順PC重みを用い、中心角cの**±90°内の和**が最大となるcを調と仮定。

EMA平滑：toneCenter ← toneCenter + α·Δ、αは0.001〜1.0から可変。

重力方向バイアスで同点時の向き決定。

### フレーム切替

water＝水面(半円)が回り円盤は固定。

disk＝半円は重力方向に固定し、円盤（放射線・ラベル・点・線）を回転。

## 表示（キャンバス）

同心円：ピアノ音域をカバー。1オクターブ目盛り。

放射線：30°刻み（=五度順）。

音名ラベル：同音異名併記（例 C#/Db）。

基準角：上= C。

重力スライダ：旧「回転」を重力方向指定に変更。

### 音イベントの描画

点：位置=極座標、サイズ/透明度=強さに比例。残光あり。

最低音/最高音を常時強調（LOW=水色、HIGH=橙）。

同時発音の線：その瞬間の低→高に並べ、隣接どうしを結ぶ。

アニメなし、即時描画。

形状は極座標の線形補間（角度は最短方向）。

## UIコントロール

mode：Mic / MIDI In / MIDI File

device：MIDI入力デバイス選択

start：オーディオ/MIDI初期化

gain（Mic前段）、monitor（Micモニター）

gravity（重力方向=五度圏インデックス、30°刻み）

tone(EMA)：α=0.001〜1.0

frame：water / disk

detect：Micの最大検出数 1–16

MIDI Fileパネル：再生/一時停止/停止、シーク、speed 10–200%

## 仕様変更の履歴（主要な確定点）

角度並び：完全5度に最終確定（途中で完全4度→5度へ変更）。

回転バー→重力バーに役割変更。

同時発音の結線：

旧案「最も周波数が近い」→**「低→高で隣接」**に確定。

線アニメーション廃止し即時表示。

最高音の可視化を追加（LOWだけでなくHIGHも）。

MIDI速度可変を追加（10–200%）。

フレーム切替を追加（水面が動く/円盤が動く）。

EMA係数レンジ拡張（最小0.001）。

## 制約・注意

ブラウザでWebAudio/WebMIDI/getUserMediaが必要。

SMF対応はノート/テンポ中心（ピッチベンド等は未対応）。

Micの多重F0は音色/雑音の影響を受ける。


# 要点まとめ（新チャット導入文向け）

## 概要

極座標のピッチ可視化ツール。半径=周波数（対数）。角度=五度圏上のピッチクラス。

マイク入力／MIDI入力／MIDIファイル再生に対応。発音点と和声音の関係を即時可視化。

調性感を「五度圏の半円」で表現し、指数移動平均（EMA）で推移を平滑化。

表示座標系を「水面が回る」か「円盤が回る」かで切替可能。

## 目的

音高配置を時間軸なしで二次元表示。

同時発音の内部関係と、進行に伴う調センターの変化（転調傾向）を視覚化。

最低音／最高音を即時強調し、和声音の上下関係を把握。

## 画面構成（UI）

- mode: Mic / MIDI In / MIDI File の切替。
- MIDI In: 入力デバイス選択。
- MIDI File: 読み込み、再生・一時停止・停止、シーク、再生速度10–200%。
- gain（Mic前段ゲイン）、monitor（モニター音量）。
- gravity（重力方向=五度圏上の参照角。旧rotate）。
- tone(EMA)（α係数、0.001–1.0相当の範囲まで調整可能）。
- frame（表示系切替）：water=水面が半円を担い回転／disk=円盤が回転。
- detect（Mic時の同時検出最大数 1–16）。
- ステータス表示（info）。

## 描画と座標系

Canvas 2D。毎フレーム描画。

同心円=1オクターブ刻み。外側ほど低音。

放射状線=30°刻み（五度順の12分割）。上向きがC。

外周に音名ラベル（同音異名併記）。

## 音イベントの表示規則

発音点：半径=log周波数、角度=五度圏位置。点サイズと透明度は強度に依存。

最低音=水色リング＋“LOW”表示。最高音=橙色リング＋“HIGH”表示。

複数同時音：周波数の低→高に並べ、隣接同士を極座標の直線補間で即時結線（アニメなし）。

## 調性推定ロジック

入力からピッチクラス重みを五度順に集計。

Mic: HPSベースの複数F0検出→PC重み化。

MIDI: 同時発音ノートのベロシティを重み化。

五度圏上で中心角cを走査し、「±90°に入る重み合計」が最大のcを調中心と仮定。

重力方向への微小バイアスで同点時の向きを決定。

EMAで toneCenter ← toneCenter + α * Δ を適用し時間平滑化。

frame=water: 半円がtoneCenterに従い回る。円盤固定。

frame=disk: 半円は重力方向に固定。円盤（放射線・ラベル・点・線）を gravAngle - toneCenter だけ回転。

## 入力処理

Mic: WebAudio + Analyser。Harmonic Product Spectrum 的手法で最大K個のF0を推定。Kはdetectで設定。

MIDI In: Web MIDI。Note On/OffでactiveNotesを更新。内蔵簡易シンセでモニター再生。

MIDI File: 独自SMFパーサ（format 0/1, PPQ）。テンポメタ対応。再生速度はタイムマッピングで可変。

## 再生・合成

内蔵PolySynth（簡易）：2オシレータ+ローパス+ADSR相当。Note On/Offに追従。

Micモニターは独立ゲイン。全体はAudioContext 48k想定。

## 可視的フィードバック

残光ドットで直近の発音を短時間保持。

最低音／最高音の強調リング。

同時発音の結線で和音内の近接関係を提示。

## 既知の前提・制限

ブラウザにWebAudio／getUserMedia／WebMIDIが必要。モバイルはユーザ操作後にAudioContextを開始。

SMFはノートとテンポ中心の実装。ピッチベンド等の表現は省略。

F0推定は帯域とSNRに依存。倍音の強い音源やノイズで誤検出あり。

## 目的に対する設計意図

「時間軸を捨て、音高を極座標に再配置」という要件に沿って、五度圏角×対数半径を採用。

調は「半円」で表現。転調はEMAで慣性付きにし、重力方向（ユーザ指定）で安定位置を持たせる。

視覚の一貫性のため、線のアニメーションは廃止し即時表示に固定。

ユースケース別に3入力経路を統一の表示層に集約。

